-- ENHANCED SILENT AIM WITH CAMLOCK, SPEED & ESP - COMBINED SCRIPT
-- Version 6.0 - Enhanced by 9tz0 with Exunys-inspired ESP

print("[Enhanced Silent Aim] Loading...")

-- ============================================================================
-- PART 1: INITIALIZATION & CONFIGURATION
-- ============================================================================

-- Load LinoriaLib UI Library
local repo = 'https://raw.githubusercontent.com/mstudio45/LinoriaLib/main/'
local Library = loadstring(game:HttpGet(repo .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(repo .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(repo .. 'addons/SaveManager.lua'))()

-- Load Silent Aim Module
loadstring(game:HttpGet("https://raw.githubusercontent.com/silentreaver/0ollin/refs/heads/main/kencarson2"))()

-- Get the Silent Aim module
local SilentAim = getgenv().SilentAim

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local ContextActionService = game:GetService("ContextActionService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- Shared Configuration (Both use same FOV)
local SharedConfig = {
    FOVRadius = 200,
    TeamCheck = false,
    VisibleCheck = false,
    AliveCheck = true,
    TargetPart = "HumanoidRootPart"
}

-- Silent Aim Configuration
local SilentConfig = {
    Enabled = false
}

-- Camera Lock Configuration
local CamlockConfig = {
    Enabled = false,
    Active = false,
    Target = nil,
    Smoothness = 0.5,
    Prediction = 0,
    StickyAim = true
}

-- Speed Configuration
local SpeedConfig = {
    Enabled = false,
    NormalMultiplier = 1.5,
    LowHealthMultiplier = 1.8,
    LowHealthThreshold = 35
}

-- Visual Configuration
local VisualConfig = {
    ShowFOV = false,
    Tracers = false,
    TracerColor = Color3.fromRGB(255, 255, 255),
    FOVColor = Color3.fromRGB(255, 255, 255)
}

-- ESP Configuration (Exunys-inspired)
local ESPConfig = {
    Enabled = false,
    Boxes = true,
    BoxColor = Color3.fromRGB(255, 255, 255),
    BoxOutline = true,
    Names = true,
    NameColor = Color3.fromRGB(255, 255, 255),
    Distance = true,
    DistanceColor = Color3.fromRGB(255, 255, 255),
    Health = true,
    HealthBar = true,
    HealthBarColor = Color3.fromRGB(0, 255, 0),
    ESPTracers = false,
    TracerColor = Color3.fromRGB(255, 255, 255),
    TracerOrigin = "Bottom", -- Bottom, Center, Mouse
    TeamCheck = false,
    TextSize = 13,
    MaxDistance = 1000
}

-- Drawing Objects
local TracerLine = Drawing.new("Line")
TracerLine.Thickness = 2
TracerLine.Visible = false
TracerLine.ZIndex = 999
TracerLine.Transparency = 1
TracerLine.Color = Color3.fromRGB(255, 255, 255)

local FOVCircle = Drawing.new("Circle")
FOVCircle.Visible = false
FOVCircle.Thickness = 2
FOVCircle.Color = Color3.fromRGB(255, 255, 255)
FOVCircle.Transparency = 1
FOVCircle.NumSides = 100
FOVCircle.Radius = 200
FOVCircle.Filled = false

-- ESP Storage
local ESPObjects = {}

-- Helper Functions
local function isAlive(player)
    if not player or not player.Character then return false end
    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    return humanoid and humanoid.Health > 0
end

local function isKnockedOut(player)
    if not player or not player.Character then return false end
    local bodyEffects = player.Character:FindFirstChild("BodyEffects")
    local ko = bodyEffects and bodyEffects:FindFirstChild("K.O")
    return ko and ko.Value
end

local function sameTeam(player)
    if not SharedConfig.TeamCheck then return false end
    return player.Team == LocalPlayer.Team
end

local function isVisible(origin, target, character)
    if not SharedConfig.VisibleCheck then return true end
    
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character, character}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    rayParams.IgnoreWater = true
    
    local result = Workspace:Raycast(origin, target.Position - origin, rayParams)
    return not result or result.Instance:IsDescendantOf(character)
end

-- Get Best Target (Used by both Silent Aim and Camlock)
local function getBestTarget(useMousePosition)
    local closestDistance = math.huge
    local closestPlayer = nil
    
    local referencePoint
    if useMousePosition then
        referencePoint = UserInputService:GetMouseLocation()
    else
        referencePoint = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            if SharedConfig.AliveCheck and not isAlive(player) then continue end
            if isKnockedOut(player) then continue end
            if sameTeam(player) then continue end
            
            local targetPart = player.Character:FindFirstChild(SharedConfig.TargetPart)
            if not targetPart then continue end
            
            if SharedConfig.VisibleCheck and not isVisible(Camera.CFrame.Position, targetPart, player.Character) then
                continue
            end
            
            local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
            if not onScreen then continue end
            
            local screenPos2D = Vector2.new(screenPos.X, screenPos.Y)
            local distance = (screenPos2D - referencePoint).Magnitude
            
            if SharedConfig.FOVRadius > 0 then
                if distance > SharedConfig.FOVRadius then continue end
            end
            
            if distance < closestDistance then
                closestDistance = distance
                closestPlayer = player
            end
        end
    end
    
    return closestPlayer
end

print("[Enhanced Silent Aim] Part 1/3 loaded - Configuration initialized")

-- ============================================================================
-- PART 2: ESP SYSTEM (Exunys-inspired)
-- ============================================================================

local function createESP(player)
    local espObj = {
        Player = player,
        Box = Drawing.new("Square"),
        BoxOutline = Drawing.new("Square"),
        Name = Drawing.new("Text"),
        Distance = Drawing.new("Text"),
        HealthBar = Drawing.new("Square"),
        HealthBarOutline = Drawing.new("Square"),
        HealthBarBackground = Drawing.new("Square"),
        Tracer = Drawing.new("Line")
    }
    
    -- Box setup
    espObj.Box.Thickness = 1
    espObj.Box.Filled = false
    espObj.Box.Color = ESPConfig.BoxColor
    espObj.Box.Visible = false
    espObj.Box.ZIndex = 2
    
    espObj.BoxOutline.Thickness = 3
    espObj.BoxOutline.Filled = false
    espObj.BoxOutline.Color = Color3.fromRGB(0, 0, 0)
    espObj.BoxOutline.Visible = false
    espObj.BoxOutline.ZIndex = 1
    
    -- Name setup
    espObj.Name.Size = ESPConfig.TextSize
    espObj.Name.Center = true
    espObj.Name.Outline = true
    espObj.Name.OutlineColor = Color3.fromRGB(0, 0, 0)
    espObj.Name.Color = ESPConfig.NameColor
    espObj.Name.Visible = false
    espObj.Name.ZIndex = 2
    
    -- Distance setup
    espObj.Distance.Size = ESPConfig.TextSize
    espObj.Distance.Center = true
    espObj.Distance.Outline = true
    espObj.Distance.OutlineColor = Color3.fromRGB(0, 0, 0)
    espObj.Distance.Color = ESPConfig.DistanceColor
    espObj.Distance.Visible = false
    espObj.Distance.ZIndex = 2
    
    -- Health bar setup
    espObj.HealthBar.Thickness = 1
    espObj.HealthBar.Filled = true
    espObj.HealthBar.Color = ESPConfig.HealthBarColor
    espObj.HealthBar.Visible = false
    espObj.HealthBar.ZIndex = 3
    
    espObj.HealthBarOutline.Thickness = 1
    espObj.HealthBarOutline.Filled = false
    espObj.HealthBarOutline.Color = Color3.fromRGB(0, 0, 0)
    espObj.HealthBarOutline.Visible = false
    espObj.HealthBarOutline.ZIndex = 2
    
    espObj.HealthBarBackground.Thickness = 1
    espObj.HealthBarBackground.Filled = true
    espObj.HealthBarBackground.Color = Color3.fromRGB(0, 0, 0)
    espObj.HealthBarBackground.Visible = false
    espObj.HealthBarBackground.ZIndex = 1
    
    -- Tracer setup
    espObj.Tracer.Thickness = 1
    espObj.Tracer.Color = ESPConfig.TracerColor
    espObj.Tracer.Visible = false
    espObj.Tracer.ZIndex = 1
    
    ESPObjects[player] = espObj
end

local function removeESP(player)
    if ESPObjects[player] then
        for _, drawing in pairs(ESPObjects[player]) do
            if type(drawing) == "userdata" and drawing.Remove then
                drawing:Remove()
            end
        end
        ESPObjects[player] = nil
    end
end

local function updateESP()
    if not ESPConfig.Enabled then
        for _, espObj in pairs(ESPObjects) do
            for _, drawing in pairs(espObj) do
                if type(drawing) == "userdata" and drawing.Visible ~= nil then
                    drawing.Visible = false
                end
            end
        end
        return
    end
    
    for player, espObj in pairs(ESPObjects) do
        if not player or not player.Parent or not player.Character then
            for _, drawing in pairs(espObj) do
                if type(drawing) == "userdata" and drawing.Visible ~= nil then
                    drawing.Visible = false
                end
            end
            continue
        end
        
        local character = player.Character
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        local head = character:FindFirstChild("Head")
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        
        if not rootPart or not head or not humanoid or humanoid.Health <= 0 then
            for _, drawing in pairs(espObj) do
                if type(drawing) == "userdata" and drawing.Visible ~= nil then
                    drawing.Visible = false
                end
            end
            continue
        end
        
        -- Team check
        if ESPConfig.TeamCheck and player.Team == LocalPlayer.Team then
            for _, drawing in pairs(espObj) do
                if type(drawing) == "userdata" and drawing.Visible ~= nil then
                    drawing.Visible = false
                end
            end
            continue
        end
        
        -- Distance check
        local distance = (rootPart.Position - Camera.CFrame.Position).Magnitude
        if distance > ESPConfig.MaxDistance then
            for _, drawing in pairs(espObj) do
                if type(drawing) == "userdata" and drawing.Visible ~= nil then
                    drawing.Visible = false
                end
            end
            continue
        end
        
        -- Get screen positions
        local rootPos, rootVis = Camera:WorldToViewportPoint(rootPart.Position)
        local headPos = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
        local legPos = Camera:WorldToViewportPoint(rootPart.Position - Vector3.new(0, 3, 0))
        
        if not rootVis then
            for _, drawing in pairs(espObj) do
                if type(drawing) == "userdata" and drawing.Visible ~= nil then
                    drawing.Visible = false
                end
            end
            continue
        end
        
        -- Calculate box dimensions
        local height = math.abs(headPos.Y - legPos.Y)
        local width = height / 2
        
        -- Update box
        if ESPConfig.Boxes then
            espObj.Box.Size = Vector2.new(width, height)
            espObj.Box.Position = Vector2.new(rootPos.X - width/2, headPos.Y)
            espObj.Box.Color = ESPConfig.BoxColor
            espObj.Box.Visible = true
            
            if ESPConfig.BoxOutline then
                espObj.BoxOutline.Size = espObj.Box.Size
                espObj.BoxOutline.Position = espObj.Box.Position
                espObj.BoxOutline.Visible = true
            else
                espObj.BoxOutline.Visible = false
            end
        else
            espObj.Box.Visible = false
            espObj.BoxOutline.Visible = false
        end
        
        -- Update name
        if ESPConfig.Names then
            espObj.Name.Text = player.DisplayName or player.Name
            espObj.Name.Position = Vector2.new(rootPos.X, headPos.Y - 16)
            espObj.Name.Color = ESPConfig.NameColor
            espObj.Name.Visible = true
        else
            espObj.Name.Visible = false
        end
        
        -- Update distance
        if ESPConfig.Distance then
            espObj.Distance.Text = string.format("[%d studs]", math.floor(distance))
            espObj.Distance.Position = Vector2.new(rootPos.X, legPos.Y + 5)
            espObj.Distance.Color = ESPConfig.DistanceColor
            espObj.Distance.Visible = true
        else
            espObj.Distance.Visible = false
        end
        
        -- Update health bar
        if ESPConfig.Health and ESPConfig.HealthBar then
            local healthPercent = humanoid.Health / humanoid.MaxHealth
            local barHeight = height
            local barWidth = 4
            
            -- Background
            espObj.HealthBarBackground.Size = Vector2.new(barWidth, barHeight)
            espObj.HealthBarBackground.Position = Vector2.new(rootPos.X - width/2 - 6, headPos.Y)
            espObj.HealthBarBackground.Visible = true
            
            -- Outline
            espObj.HealthBarOutline.Size = Vector2.new(barWidth, barHeight)
            espObj.HealthBarOutline.Position = espObj.HealthBarBackground.Position
            espObj.HealthBarOutline.Visible = true
            
            -- Health bar
            espObj.HealthBar.Size = Vector2.new(barWidth, barHeight * healthPercent)
            espObj.HealthBar.Position = Vector2.new(
                espObj.HealthBarBackground.Position.X,
                espObj.HealthBarBackground.Position.Y + (barHeight * (1 - healthPercent))
            )
            local healthColor = Color3.fromRGB(
                255 * (1 - healthPercent),
                255 * healthPercent,
                0
            )
            espObj.HealthBar.Color = healthColor
            espObj.HealthBar.Visible = true
        else
            espObj.HealthBar.Visible = false
            espObj.HealthBarOutline.Visible = false
            espObj.HealthBarBackground.Visible = false
        end
        
        -- Update tracer
        if ESPConfig.ESPTracers then
            local fromPos
            if ESPConfig.TracerOrigin == "Bottom" then
                fromPos = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
            elseif ESPConfig.TracerOrigin == "Center" then
                fromPos = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
            else -- Mouse
                fromPos = UserInputService:GetMouseLocation()
            end
            
            espObj.Tracer.From = fromPos
            espObj.Tracer.To = Vector2.new(rootPos.X, rootPos.Y)
            espObj.Tracer.Color = ESPConfig.TracerColor
            espObj.Tracer.Visible = true
        else
            espObj.Tracer.Visible = false
        end
    end
end

-- Initialize ESP for existing players
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        createESP(player)
    end
end

-- Handle new players
Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        createESP(player)
    end
end)

-- Handle players leaving
Players.PlayerRemoving:Connect(function(player)
    removeESP(player)
end)

print("[Enhanced Silent Aim] ESP System loaded")

-- ============================================================================
-- PART 3: CORE LOGIC & FUNCTIONALITY
-- ============================================================================

-- Apply Speed Modifications
local function applySpeed()
    if not SpeedConfig.Enabled then return end
    
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    local health = humanoid.Health
    local baseSpeed = 16
    
    if health <= SpeedConfig.LowHealthThreshold then
        humanoid.WalkSpeed = baseSpeed * SpeedConfig.LowHealthMultiplier
    else
        humanoid.WalkSpeed = baseSpeed * SpeedConfig.NormalMultiplier
    end
end

-- Hook Humanoid for Speed
local function hookHumanoid(humanoid)
    applySpeed()
    humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
        if SpeedConfig.Enabled then
            applySpeed()
        end
    end)
    humanoid.HealthChanged:Connect(applySpeed)
end

LocalPlayer.CharacterAdded:Connect(function(char)
    local hum = char:WaitForChild("Humanoid", 10)
    if hum then hookHumanoid(hum) end
end)

if LocalPlayer.Character then
    local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if hum then hookHumanoid(hum) end
end

-- Controller Binds Setup
local function setupControllerBinds()
    -- LT (Left Trigger) for Camlock Toggle
    ContextActionService:BindAction("CamlockToggle", function(actionName, inputState, inputObject)
        if inputState == Enum.UserInputState.Begin then
            if CamlockConfig.Enabled then
                CamlockConfig.Active = not CamlockConfig.Active
                
                if CamlockConfig.Active then
                    CamlockConfig.Target = getBestTarget(true)
                else
                    CamlockConfig.Target = nil
                end
            end
        end
    end, false, Enum.KeyCode.ButtonL2)
    
    -- Left Stick Click for Speed Toggle
    ContextActionService:BindAction("SpeedToggle", function(actionName, inputState, inputObject)
        if inputState == Enum.UserInputState.Begin then
            SpeedConfig.Enabled = not SpeedConfig.Enabled
            if not SpeedConfig.Enabled then
                local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.WalkSpeed = 16
                end
            else
                applySpeed()
            end
        end
    end, false, Enum.KeyCode.ButtonL3)
end

setupControllerBinds()

-- Camlock Loop
local lastCamlockUpdate = 0
local CAMLOCK_UPDATE_RATE = 1/60

RunService.Heartbeat:Connect(function(dt)
    if not CamlockConfig.Enabled or not CamlockConfig.Active then
        return
    end
    
    if CamlockConfig.Target then
        if not CamlockConfig.Target.Character then
            CamlockConfig.Target = nil
            CamlockConfig.Active = false
            return
        end
        
        if not isAlive(CamlockConfig.Target) or isKnockedOut(CamlockConfig.Target) then
            CamlockConfig.Target = nil
            CamlockConfig.Active = false
            return
        end
        
        if sameTeam(CamlockConfig.Target) then
            CamlockConfig.Target = nil
            CamlockConfig.Active = false
            return
        end
    else
        CamlockConfig.Active = false
        return
    end
    
    local target = CamlockConfig.Target
    local targetPart = target.Character:FindFirstChild(SharedConfig.TargetPart)
    
    if not targetPart then return end
    
    if tick() - lastCamlockUpdate < CAMLOCK_UPDATE_RATE then return end
    lastCamlockUpdate = tick()
    
    local targetPos = targetPart.Position
    if CamlockConfig.Prediction > 0 then
        local root = target.Character:FindFirstChild("HumanoidRootPart")
        if root then
            targetPos = targetPos + (root.Velocity * CamlockConfig.Prediction)
        end
    end
    
    local targetCFrame = CFrame.new(Camera.CFrame.Position, targetPos)
    local smoothFactor = 1 - math.exp(-CamlockConfig.Smoothness * dt * 60)
    Camera.CFrame = Camera.CFrame:Lerp(targetCFrame, smoothFactor)
end)

-- Silent Aim & ESP Update Loop
local updateConnection
updateConnection = RunService.Heartbeat:Connect(function()
    pcall(function()
        -- Update ESP
        updateESP()
        
        if not TracerLine or not FOVCircle then return end
        
        local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
        
        -- Update FOV Circle
        FOVCircle.Position = screenCenter
        FOVCircle.Radius = SharedConfig.FOVRadius
        FOVCircle.Visible = VisualConfig.ShowFOV
        FOVCircle.Color = VisualConfig.FOVColor
        
        -- Determine target priority
        local target = nil
        if CamlockConfig.Active and CamlockConfig.Target then
            target = CamlockConfig.Target
        elseif SilentConfig.Enabled then
            target = getBestTarget(false)
        end
        
        -- Update Silent Aim
        if target and target.Character then
            local targetPart = target.Character:FindFirstChild(SharedConfig.TargetPart)
            if targetPart then
                SilentAim:SetTarget(targetPart)
                
                if VisualConfig.Tracers then
                    local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
                    if onScreen then
                        TracerLine.Visible = true
                        TracerLine.From = screenCenter
                        TracerLine.To = Vector2.new(screenPos.X, screenPos.Y)
                        TracerLine.Color = VisualConfig.TracerColor
                    else
                        TracerLine.Visible = false
                    end
                else
                    TracerLine.Visible = false
                end
            else
                SilentAim:ClearTarget()
                TracerLine.Visible = false
            end
        else
            SilentAim:ClearTarget()
            TracerLine.Visible = false
        end
    end)
end)

print("[Enhanced Silent Aim] Part 2/3 loaded - Core logic initialized")

-- ============================================================================
-- PART 4: USER INTERFACE
-- ============================================================================

-- Create UI
local Window = Library:CreateWindow({
    Title = 'Enhanced Silent Aim v6.0 by 9tz0',
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})

local Tabs = {
    Main = Window:AddTab('Silent Aim'),
    Camlock = Window:AddTab('Camera Lock'),
    ESP = Window:AddTab('ESP'),
    Speed = Window:AddTab('Speed'),
    Visuals = Window:AddTab('Visuals'),
    Settings = Window:AddTab('Settings')
}

-- Main Tab (Silent Aim)
local AimbotGroup = Tabs.Main:AddLeftGroupbox('Silent Aimbot')

AimbotGroup:AddToggle('EnabledToggle', {
    Text = 'Enable Silent Aim',
    Default = false,
    Tooltip = 'Enable silent aimbot',
    Callback = function(value)
        SilentConfig.Enabled = value
        SilentAim.Enabled = value
    end
})

AimbotGroup:AddSlider('HitChanceSlider', {
    Text = 'Hit Chance %',
    Default = 100,
    Min = 0,
    Max = 100,
    Rounding = 0,
    Compact = false,
    Callback = function(value)
        SilentAim.HitChance = value
    end
})

AimbotGroup:AddSlider('PredictionSlider', {
    Text = 'Prediction',
    Default = 0,
    Min = 0,
    Max = 0.5,
    Rounding = 2,
    Compact = false,
    Callback = function(value)
        SilentAim.Prediction = value
    end
})

-- Shared Settings Group
local SharedGroup = Tabs.Main:AddRightGroupbox('Shared Settings')

SharedGroup:AddLabel('These settings affect both')
SharedGroup:AddLabel('Silent Aim and Camera Lock')
SharedGroup:AddDivider()

SharedGroup:AddSlider('FOVSlider', {
    Text = 'FOV Radius',
    Default = 200,
    Min = 0,
    Max = 500,
    Rounding = 0,
    Compact = false,
    Tooltip = 'Shared FOV for both systems',
    Callback = function(value)
        SharedConfig.FOVRadius = value
    end
})

SharedGroup:AddDropdown('TargetPartDropdown', {
    Values = {'Head', 'HumanoidRootPart', 'UpperTorso', 'LowerTorso'},
    Default = 2,
    Multi = false,
    Text = 'Target Part',
    Tooltip = 'Select body part to target',
    Callback = function(value)
        SharedConfig.TargetPart = value
        SilentAim.TargetPart = value
    end
})

SharedGroup:AddToggle('TeamCheckToggle', {
    Text = 'Team Check',
    Default = false,
    Callback = function(value)
        SharedConfig.TeamCheck = value
    end
})

SharedGroup:AddToggle('VisibleCheckToggle', {
    Text = 'Visible Check',
    Default = false,
    Callback = function(value)
        SharedConfig.VisibleCheck = value
    end
})

SharedGroup:AddToggle('AliveCheckToggle', {
    Text = 'Alive Check',
    Default = true,
    Callback = function(value)
        SharedConfig.AliveCheck = value
    end
})

-- Camlock Tab
local CamlockGroup = Tabs.Camlock:AddLeftGroupbox('Camera Lock')

CamlockGroup:AddToggle('CamlockEnabledToggle', {
    Text = 'Enable Camera Lock',
    Default = false,
    Tooltip = 'Press LT (Controller) to toggle',
    Callback = function(value)
        CamlockConfig.Enabled = value
        if not value then
            CamlockConfig.Active = false
            CamlockConfig.Target = nil
        end
    end
})

CamlockGroup:AddSlider('CamlockSmoothnessSlider', {
    Text = 'Smoothness',
    Default = 0.5,
    Min = 0.1,
    Max = 2,
    Rounding = 2,
    Compact = false,
    Callback = function(value)
        CamlockConfig.Smoothness = value
    end
})

CamlockGroup:AddSlider('CamlockPredictionSlider', {
    Text = 'Prediction',
    Default = 0,
    Min = 0,
    Max = 0.5,
    Rounding = 2,
    Compact = false,
    Callback = function(value)
        CamlockConfig.Prediction = value
    end
})

-- Sticky Aim Info
local StickyGroup = Tabs.Camlock:AddRightGroupbox('Sticky Aim Info')

StickyGroup:AddLabel('Sticky Aim is ALWAYS ON')
StickyGroup:AddDivider()
StickyGroup:AddLabel('Target will stay locked until:')
StickyGroup:AddLabel('• You press LT again (unlock)')
StickyGroup:AddLabel('• Target gets knocked out')
StickyGroup:AddLabel('• Target dies')
StickyGroup:AddDivider()
StickyGroup:AddLabel('Target WILL NOT unlock if:')
StickyGroup:AddLabel('• Mouse moves away')
StickyGroup:AddLabel('• Target goes off screen')
StickyGroup:AddLabel('• You look away')

-- ESP Tab (Exunys-inspired)
local ESPMainGroup:AddToggle('NamesToggle', {
    Text = 'Show Names',
    Default = true,
    Callback = function(value)
        ESPConfig.Names = value
    end
})

ESPMainGroup:AddToggle('DistanceToggle', {
    Text = 'Show Distance',
    Default = true,
    Callback = function(value)
        ESPConfig.Distance = value
    end
})

ESPMainGroup:AddToggle('HealthToggle', {
    Text = 'Show Health',
    Default = true,
    Callback = function(value)
        ESPConfig.Health = value
    end
})

ESPMainGroup:AddToggle('HealthBarToggle', {
    Text = 'Health Bar',
    Default = true,
    Callback = function(value)
        ESPConfig.HealthBar = value
    end
})

ESPMainGroup:AddToggle('ESPTracersToggle', {
    Text = 'ESP Tracers',
    Default = false,
    Callback = function(value)
        ESPConfig.ESPTracers = value
    end
})

local ESPConfigGroup = Tabs.ESP:AddRightGroupbox('ESP Configuration')

ESPConfigGroup:AddSlider('MaxDistanceSlider', {
    Text = 'Max Distance',
    Default = 1000,
    Min = 100,
    Max = 5000,
    Rounding = 0,
    Compact = false,
    Callback = function(value)
        ESPConfig.MaxDistance = value
    end
})

ESPConfigGroup:AddSlider('TextSizeSlider', {
    Text = 'Text Size',
    Default = 13,
    Min = 10,
    Max = 20,
    Rounding = 0,
    Compact = false,
    Callback = function(value)
        ESPConfig.TextSize = value
        for _, espObj in pairs(ESPObjects) do
            espObj.Name.Size = value
            espObj.Distance.Size = value
        end
    end
})

ESPConfigGroup:AddDropdown('TracerOriginDropdown', {
    Values = {'Bottom', 'Center', 'Mouse'},
    Default = 1,
    Multi = false,
    Text = 'Tracer Origin',
    Callback = function(value)
        ESPConfig.TracerOrigin = value
    end
})

ESPConfigGroup:AddToggle('ESPTeamCheckToggle', {
    Text = 'Team Check',
    Default = false,
    Callback = function(value)
        ESPConfig.TeamCheck = value
    end
})

local ESPColorsGroup = Tabs.ESP:AddLeftGroupbox('ESP Colors')

ESPColorsGroup:AddLabel('Box Color'):AddColorPicker('BoxColor', {
    Default = Color3.fromRGB(255, 255, 255),
    Title = 'Box Color',
    Transparency = 0,
    Callback = function(value)
        ESPConfig.BoxColor = value
    end
})

ESPColorsGroup:AddLabel('Name Color'):AddColorPicker('NameColor', {
    Default = Color3.fromRGB(255, 255, 255),
    Title = 'Name Color',
    Transparency = 0,
    Callback = function(value)
        ESPConfig.NameColor = value
    end
})

ESPColorsGroup:AddLabel('Distance Color'):AddColorPicker('DistanceColor', {
    Default = Color3.fromRGB(255, 255, 255),
    Title = 'Distance Color',
    Transparency = 0,
    Callback = function(value)
        ESPConfig.DistanceColor = value
    end
})

ESPColorsGroup:AddLabel('Tracer Color'):AddColorPicker('ESPTracerColor', {
    Default = Color3.fromRGB(255, 255, 255),
    Title = 'ESP Tracer Color',
    Transparency = 0,
    Callback = function(value)
        ESPConfig.TracerColor = value
    end
})

-- Speed Tab
local SpeedGroup = Tabs.Speed:AddLeftGroupbox('Movement Speed')

SpeedGroup:AddToggle('SpeedEnabledToggle', {
    Text = 'Enable Speed Mod',
    Default = false,
    Tooltip = 'Press L3 (Left Stick) to toggle',
    Callback = function(value)
        SpeedConfig.Enabled = value
        if not value then
            local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = 16
            end
        else
            applySpeed()
        end
    end
})

SpeedGroup:AddSlider('NormalSpeedSlider', {
    Text = 'Normal Speed Multiplier',
    Default = 1.5,
    Min = 3,
    Max = 25,
    Rounding = 1,
    Compact = false,
    Callback = function(value)
        SpeedConfig.NormalMultiplier = value
        applySpeed()
    end
})

SpeedGroup:AddSlider('LowHealthSpeedSlider', {
    Text = 'Low Health Speed Multiplier',
    Default = 1.8,
    Min = 13,
    Max = 25,
    Rounding = 1,
    Compact = false,
    Callback = function(value)
        SpeedConfig.LowHealthMultiplier = value
        applySpeed()
    end
})

SpeedGroup:AddSlider('LowHealthThresholdSlider', {
    Text = 'Low Health Threshold',
    Default = 15,
    Min = 5,
    Max = 80,
    Rounding = 0,
    Compact = false,
    Callback = function(value)
        SpeedConfig.LowHealthThreshold = value
    end
})

-- Visuals Tab
local VisualsGroup = Tabs.Visuals:AddLeftGroupbox('Visuals')

VisualsGroup:AddToggle('ShowFOVToggle', {
    Text = 'Show FOV Circle',
    Default = false,
    Tooltip = 'Shows shared FOV for both systems',
    Callback = function(value)
        VisualConfig.ShowFOV = value
    end
})

VisualsGroup:AddToggle('TracersToggle', {
    Text = 'Show Tracers',
    Default = false,
    Callback = function(value)
        VisualConfig.Tracers = value
    end
})

VisualsGroup:AddLabel('FOV Color'):AddColorPicker('FOVColor', {
    Default = Color3.fromRGB(255, 255, 255),
    Title = 'FOV Circle Color',
    Transparency = 0,
    Callback = function(value)
        VisualConfig.FOVColor = value
        FOVCircle.Color = value
    end
})

VisualsGroup:AddLabel('Tracer Color'):AddColorPicker('TracerColor', {
    Default = Color3.fromRGB(255, 255, 255),
    Title = 'Tracer Line Color',
    Transparency = 0,
    Callback = function(value)
        VisualConfig.TracerColor = value
        TracerLine.Color = value
    end
})

-- Settings Tab
local MenuGroup = Tabs.Settings:AddLeftGroupbox('Menu')

MenuGroup:AddButton('Unload Script', function()
    if SilentAim then
        SilentAim:Unload()
    end
    if updateConnection then
        updateConnection:Disconnect()
    end
    if TracerLine then
        TracerLine:Remove()
    end
    if FOVCircle then
        FOVCircle:Remove()
    end
    for _, espObj in pairs(ESPObjects) do
        for _, drawing in pairs(espObj) do
            if type(drawing) == "userdata" and drawing.Remove then
                drawing:Remove()
            end
        end
    end
    ESPObjects = {}
    ContextActionService:UnbindAction("CamlockToggle")
    ContextActionService:UnbindAction("SpeedToggle")
    Library:Unload()
    getgenv().EnhancedSilentAim = nil
end)

MenuGroup:AddLabel('Press RightShift to toggle menu')
MenuGroup:AddLabel('Version: 6.0 - Enhanced + ESP')

local ControlsGroup = Tabs.Settings:AddRightGroupbox('Controller Controls')

ControlsGroup:AddLabel('LT (L2) - Toggle Camlock')
ControlsGroup:AddLabel('L3 (Left Stick Click) - Toggle Speed')
ControlsGroup:AddDivider()
ControlsGroup:AddLabel('Priority System:')
ControlsGroup:AddLabel('1. Camlocked target (if active)')
ControlsGroup:AddLabel('2. Closest target in FOV')
ControlsGroup:AddDivider()
ControlsGroup:AddLabel('Shared FOV means both systems')
ControlsGroup:AddLabel('use the same FOV radius')

-- Setup Managers
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)

SaveManager:IgnoreThemeSettings()

ThemeManager:SetFolder('EnhancedSilentAim')
SaveManager:SetFolder('EnhancedSilentAim/configs')

SaveManager:BuildConfigSection(Tabs.Settings)
ThemeManager:ApplyToTab(Tabs.Settings)

SaveManager:LoadAutoloadConfig()

print("[Enhanced Silent Aim] Part 3/3 loaded - UI initialized")
print("[Enhanced Silent Aim] All systems ready!")
print("[Enhanced Silent Aim] Script fully loaded and operational with ESP!") = Tabs.ESP:AddLeftGroupbox('ESP Settings')

ESPMainGroup:AddToggle('ESPEnabledToggle', {
    Text = 'Enable ESP',
    Default = false,
    Tooltip = 'Enable Exunys-inspired ESP',
    Callback = function(value)
        ESPConfig.Enabled = value
    end
})

ESPMainGroup:AddToggle('BoxesToggle', {
    Text = 'Show Boxes',
    Default = true,
    Callback = function(value)
        ESPConfig.Boxes = value
    end
})

ESPMainGroup:AddToggle('BoxOutlineToggle', {
    Text = 'Box Outline',
    Default = true,
    Callback = function(value)
        ESPConfig.BoxOutline = value
    end
})

ESPMainGroup
